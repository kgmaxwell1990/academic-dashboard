<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Academia Dashboard</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.8/dc.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" type="text/css" />
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.8/dc.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js" ></script>
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
    <h1>Gender in Academia</h1>
    <div class="row">
        <div class="col-xs-4">
        <div id="chart1"></div>
        </div>
        <div class="col-xs-4">
        <div id="chart2"></div>
        </div>
        <div class="col-xs-4">
        <div id="chart3"></div>
        </div>
    </div>
    
    <script>
    
        queue()
            .defer(d3.csv, 'data/Salaries.csv')
            .await(makeGraphs);
            
        function makeGraphs(error, salariesData){
            
            var ndx = crossfilter(salariesData);  

            salariesData.forEach(function(d) {
                d.salary = parseFloat(d.salary);
                if (isNaN(d.salary)) {
                    d.salary = 0;
                }
            });
            
            salariesData.forEach(function(d) {
                d.yrs_service = parseFloat(d.yrs_service);
                if (isNaN(d.yrs_service)) {
                    d.salary = 0;
            }});

            var gender_dim = ndx.dimension(dc.pluck('sex'));
            var count_by_gender = gender_dim.group();
            
            dc.barChart("#chart1")
                .height(300)
                .width(400)
                .margins({top: 10, right: 50, bottom: 30, left: 50})
                .dimension(gender_dim)
                .group(count_by_gender)
                .transitionDuration(500)
                .x(d3.scale.ordinal())
                .xUnits(dc.units.ordinal)
                .xAxisLabel("Gender")
                .yAxisLabel("no. in academia")
                .yAxis().ticks(10);
              
              
            function add_item(p, v) {
                p.count++;
                p.total += v.salary;
                p.average = p.total / p.count;
                return p;
            }
    
            function remove_item(p, v) {
                p.count--;
                if(p.count == 0) {
                    p.total = 0;
                    p.average = 0;
                }else {
                    p.total -= v.salary;
                    p.average = p.total / p.count;
                }
                return p;
            }
            
            function init() {
                return {count:0, total:0, average:0};
            }
            
            var av_salary = gender_dim.group().reduce(add_item, remove_item, init);
                
                
            dc.barChart("#chart2")
                .height(300)
                .width(400)
                .margins({top: 10, right: 50, bottom: 30, left: 50})
                .dimension(gender_dim)
                .group(av_salary)
                .valueAccessor(function(d){
                    return d.value.average;
                })
                .transitionDuration(500)
                .x(d3.scale.ordinal())
                .xUnits(dc.units.ordinal)
                .xAxisLabel("Gender")
                .yAxis().ticks(10);
                
                
                
            function add_item_2(p, v) {
                p.count++;
                p.total += v.yrs_service;
                p.average = p.total / p.count;
                return p;
            }
    
            function remove_item_2(p, v) {
                p.count--;
                if(p.count == 0) {
                    p.total = 0;
                    p.average = 0;
                }else {
                    p.total -= v.yrs_service;
                    p.average = p.total / p.count;
                }
                return p;
            }
                
            var gender_dim = ndx.dimension(dc.pluck('sex'));
            var av_yrs_service = gender_dim.group().reduce(add_item_2, remove_item_2, init);
            
            dc.barChart("#chart3")
                .height(300)
                .width(400)
                .margins({top: 10, right: 50, bottom: 30, left: 50})
                .dimension(gender_dim)
                .group(av_yrs_service)
                .valueAccessor(function(d){
                    return d.value.average;
                })
                .transitionDuration(500)
                .x(d3.scale.ordinal())
                .xUnits(dc.units.ordinal)
                .xAxisLabel("Gender")
                .yAxis().ticks(10);
            dc.renderAll()
        }
        
    </script>
</body>
</html>
